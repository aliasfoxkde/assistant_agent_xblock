<div class="voice-assistance-xblock" id="voice-assistance-{{id_suffix}}">
    <!-- Floating Voice Assistant Button -->
    <div class="voice-assistant-button" id="voice-assistant-button-{{id_suffix}}">
        <div class="voice-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15C13.66 15 15 13.66 15 12V5C15 3.34 13.66 2 12 2C10.34 2 9 3.34 9 5V12C9 13.66 10.34 15 12 15Z" fill="currentColor"/>
                <path d="M17 11C17 13.76 14.76 16 12 16C9.24 16 7 13.76 7 11H5C5 14.53 7.61 17.43 11 17.92V21H13V17.92C16.39 17.43 19 14.53 19 11H17Z" fill="currentColor"/>
            </svg>
        </div>

        <!-- Notification Badge -->
        {% if notification_count > 0 %}
        <div class="notification-badge" id="notification-badge-{{id_suffix}}">
            {{notification_count}}
        </div>
        {% endif %}
    </div>

    <!-- Expandable Chat Panel -->
    <div class="voice-assistant-panel" id="voice-assistant-panel-{{id_suffix}}">
        <!-- Header -->
        <div class="panel-header">
            <div class="panel-title">Voice Assistant</div>
            <div class="panel-context-badge" id="context-badge-{{id_suffix}}">Current Section</div>
            <div class="panel-controls">
                <button class="panel-history-button" id="history-button-{{id_suffix}}" aria-label="View history">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 3C8.03 3 4 7.03 4 12H1L4.89 15.89L4.96 16.03L9 12H6C6 8.13 9.13 5 13 5C16.87 5 20 8.13 20 12C20 15.87 16.87 19 13 19C11.07 19 9.32 18.21 8.06 16.94L6.64 18.36C8.27 20 10.5 21 13 21C17.97 21 22 16.97 22 12C22 7.03 17.97 3 13 3ZM12 8V13L16.28 15.54L17 14.33L13.5 12.25V8H12Z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="panel-settings-button" id="settings-button-{{id_suffix}}" aria-label="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.14 12.94C19.18 12.64 19.2 12.33 19.2 12C19.2 11.68 19.18 11.36 19.13 11.06L21.16 9.48C21.34 9.34 21.39 9.07 21.28 8.87L19.36 5.55C19.24 5.33 18.99 5.26 18.77 5.33L16.38 6.29C15.88 5.91 15.35 5.59 14.76 5.35L14.4 2.81C14.36 2.57 14.16 2.4 13.92 2.4H10.08C9.84 2.4 9.65 2.57 9.61 2.81L9.25 5.35C8.66 5.59 8.12 5.92 7.63 6.29L5.24 5.33C5.02 5.26 4.77 5.33 4.65 5.55L2.74 8.87C2.62 9.09 2.66 9.34 2.86 9.48L4.89 11.06C4.84 11.36 4.8 11.69 4.8 12C4.8 12.31 4.82 12.64 4.87 12.94L2.84 14.52C2.66 14.66 2.61 14.93 2.72 15.13L4.64 18.45C4.76 18.67 5.01 18.74 5.23 18.67L7.62 17.71C8.12 18.09 8.65 18.41 9.24 18.65L9.6 21.19C9.65 21.43 9.84 21.6 10.08 21.6H13.92C14.16 21.6"  fill="currentColor"/>
                    </svg>
                </button>
                <button class="panel-minimize-button" id="minimize-button-{{id_suffix}}" aria-label="Minimize">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 13H5V11H19V13Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Conversation Area -->
        <div class="conversation-area" id="conversation-area-{{id_suffix}}">
            <div class="welcome-message">
                <h3>Hi there! How can I help you with your course?</h3>
                <p>You can ask me questions or get assistance with your current material.</p>
            </div>
            <!-- Conversation messages will be inserted here dynamically -->
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <input type="text" class="text-input" id="text-input-{{id_suffix}}" placeholder="Type your question...">
            <button class="voice-recording-button" id="voice-recording-button-{{id_suffix}}" aria-label="Record voice">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15C13.66 15 15 13.66 15 12V5C15 3.34 13.66 2 12 2C10.34 2 9 3.34 9 5V12C9 13.66 10.34 15 12 15Z" fill="currentColor"/>
                    <path d="M17 11C17 13.76 14.76 16 12 16C9.24 16 7 13.76 7 11H5C5 14.53 7.61 17.43 11 17.92V21H13V17.92C16.39 17.43 19 14.53 19 11H17Z" fill="currentColor"/>
                </svg>
            </button>
            <button class="send-button" id="send-button-{{id_suffix}}" aria-label="Send message">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel-{{id_suffix}}">
        <div class="panel-header">
            <div class="panel-title">Voice Settings</div>
            <button class="panel-close-button" id="settings-close-{{id_suffix}}" aria-label="Close settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
        
        <div class="settings-content">
            <div class="settings-group">
                <label for="voice-select-{{id_suffix}}">Voice</label>
                <select id="voice-select-{{id_suffix}}" class="voice-select">
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            
            <div class="settings-group">
                <label for="language-select-{{id_suffix}}">Language</label>
                <select id="language-select-{{id_suffix}}" class="language-select">
                    <option value="en-US" {% if language == "en-US" %}selected{% endif %}>English (US)</option>
                    <option value="en-GB" {% if language == "en-GB" %}selected{% endif %}>English (UK)</option>
                    <option value="es-ES" {% if language == "es-ES" %}selected{% endif %}>Spanish</option>
                    <option value="fr-FR" {% if language == "fr-FR" %}selected{% endif %}>French</option>
                    <option value="de-DE" {% if language == "de-DE" %}selected{% endif %}>German</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label for="speaking-rate-{{id_suffix}}">Speaking Rate: <span id="rate-value-{{id_suffix}}">{{speaking_rate}}</span></label>
                <input type="range" id="speaking-rate-{{id_suffix}}" class="speaking-rate" 
                       min="0.5" max="2.0" step="0.1" value="{{speaking_rate}}">
            </div>
            
            <div class="settings-group">
                <label for="volume-{{id_suffix}}">Volume: <span id="volume-value-{{id_suffix}}">{{volume}}</span></label>
                <input type="range" id="volume-{{id_suffix}}" class="volume" 
                       min="0.0" max="1.0" step="0.1" value="{{volume}}">
            </div>
            
            <div class="settings-actions">
                <button id="save-settings-{{id_suffix}}" class="save-settings-button">Save Settings</button>
                <button id="reset-settings-{{id_suffix}}" class="reset-settings-button">Reset to Default</button>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="history-panel-{{id_suffix}}">
        <div class="panel-header">
            <div class="panel-title">Conversation History</div>
            <button class="panel-close-button" id="history-close-{{id_suffix}}" aria-label="Close history">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
        
        <div class="history-content" id="history-content-{{id_suffix}}">
            <!-- Will be populated dynamically -->
            <div class="empty-history-message" {% if has_history %}style="display:none"{% endif %}>
                <p>No conversation history yet.</p>
            </div>
        </div>
        
        <div class="history-actions">
            <button id="clear-history-{{id_suffix}}" class="clear-history-button">Clear History</button>
        </div>
    </div>
</div>
